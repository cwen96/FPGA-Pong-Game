/*
 * adventures_with_ip.c
 *
 * Main source file. Contains main() and menu() functions.
 */
#include "adventures_with_ip.h"
#include <xil_cache.h>


/* ---------------------------------------------------------------------------- *
 * 									main()										*
 * ---------------------------------------------------------------------------- *
 * Runs all initial setup functions to initialise the audio codec and IP
 * peripherals, before calling the interactive menu system.
 * ---------------------------------------------------------------------------- */
int main(void) {
	Xil_DCacheDisable();

	xil_printf("Entering Main\r\n");
	Xil_SetTlbAttributes(0xFFFF0000,0x14de2);
    // Configure the IIC data structure
    IicConfig(XPAR_XIICPS_0_DEVICE_ID);

    // Configure the Audio Codec's PLL
    AudioPllConfig();

    // Configure the Line in and Line out ports.
    // Call LineInLineOutConfig() for a configuration that
    // enables the HP jack too.
    AudioConfigureJacks();

    xil_printf("ADAU1761 configured\n\r");

    /* Initialise GPIO peripherals */
    gpio_init();

    xil_printf("GPIO configured\r\n");

    /* Display interactive menu interface via terminal */
    menu();
    return 1;
}

/* ---------------------------------------------------------------------------- *
 * 									menu()										*
 * ---------------------------------------------------------------------------- *
 * Presented at system startup. Allows the user to select between three
 * options by pressing certain keys on the keyboard:
 * 		's' - 	Audio loopback streaming
 * 		'x' - 	Start Lab Test
 * 	This menu is shown upon exiting from any of the above options.
 * ---------------------------------------------------------------------------- */
void menu() {
    u8 inp = 0x00;
    u32 CntrlRegister;

    /* Turn off all LEDs */
    Xil_Out32(LED_BASE, 0);

    CntrlRegister = XUartPs_ReadReg(UART_BASEADDR, XUARTPS_CR_OFFSET);

    XUartPs_WriteReg(UART_BASEADDR, XUARTPS_CR_OFFSET,
                     ((CntrlRegister & ~XUARTPS_CR_EN_DIS_MASK) |
                      XUARTPS_CR_TX_EN | XUARTPS_CR_RX_EN));

    xil_printf("\r\n\r\n");
    xil_printf("ENSC 452 Lab Test\r\n");
    xil_printf("Enter 's' to stream pure audio or 'x' to start lab test\r\n");
    xil_printf("----------------------------------------\r\n");

    // Wait for input from UART via the terminal
    while (!XUartPs_IsReceiveData(UART_BASEADDR));
    inp = XUartPs_ReadReg(UART_BASEADDR, XUARTPS_FIFO_OFFSET);
    // Select function based on UART input
    switch (inp) {
        case 's':
            xil_printf("STREAMING AUDIO\r\n");
            xil_printf("Press 'q' to return to the main menu\r\n");
            audio_stream();
            break;
        case 'x':
            xil_printf("STARTING LAB TEST\r\n");
            xil_printf("Press 'q' to return to the main menu\r\n");
            lab_test();
            break;
        default:
            menu();
            break;
    }  // switch
}  // menu()
