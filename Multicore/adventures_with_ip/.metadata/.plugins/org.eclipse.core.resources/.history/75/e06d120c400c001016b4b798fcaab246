/*
 * adventures_with_ip.c
 *
 * Main source file. Contains main() and menu() functions.
 */
#include "adventures_with_ip.h"
#include <xil_cache.h>

/* ---------------------------------------------------------------------------- *
 * 									main()										*
 * ---------------------------------------------------------------------------- *
 * Runs all initial setup functions to initialise the audio codec and IP
 * peripherals, before calling the interactive menu system.
 * ---------------------------------------------------------------------------- */
int main(void) {
	//Xil_DCacheDisable();

	xil_printf("Entering Main\r\n");
	Xil_SetTlbAttributes(0xFFFF0000,0x14de2);
    // Configure the IIC data structure
    IicConfig(XPAR_XIICPS_0_DEVICE_ID);

    // Configure the Audio Codec's PLL
    AudioPllConfig();

    // Configure the Line in and Line out ports.
    // Call LineInLineOutConfig() for a configuration that
    // enables the HP jack too.
    AudioConfigureJacks();

    xil_printf("ADAU1761 configured\n\r");

    /* Initialise GPIO peripherals */
    gpio_init();

    xil_printf("GPIO configured\r\n");

    loadAudioSD();

    xil_printf("Audio from SD card configured\r\n");

    /* Display interactive menu interface via terminal */
    play_audio();
    return 1;
}

/* ---------------------------------------------------------------------------- *
 * 									menu()										*
 * ---------------------------------------------------------------------------- *
 * Presented at system startup. Allows the user to select between three
 * options by pressing certain keys on the keyboard:
 * 		's' - 	Audio loopback streaming
 * 		'x' - 	Start Lab Test
 * 	This menu is shown upon exiting from any of the above options.
 * ---------------------------------------------------------------------------- */
void play_audio() {
    u8 inp = 0x00;
    u32 CntrlRegister;

    /* Turn off all LEDs */
    Xil_Out32(LED_BASE, 0);

    CntrlRegister = XUartPs_ReadReg(UART_BASEADDR, XUARTPS_CR_OFFSET);

    XUartPs_WriteReg(UART_BASEADDR, XUARTPS_CR_OFFSET,
                     ((CntrlRegister & ~XUARTPS_CR_EN_DIS_MASK) |
                      XUARTPS_CR_TX_EN | XUARTPS_CR_RX_EN));

    soundIndex = Xil_In32(0xFFFF3000);

    if (soundIndex == 0) {
    	playCollisionSound();
    	 Xil_Out32(0xFFFF3000, -1);
    } else if (soundIndex == 1) {
    	playBGMSound();
    	 Xil_Out32(0xFFFF3000, -1);
    }  else if (soundIndex == 2) {
    	playGameOverSound();
    	 Xil_Out32(0xFFFF3000, -1);
    } else if (soundIndex == 3) {
    	playEndRoundSound();
    	 Xil_Out32(0xFFFF3000, -1);
    }

    play_audio();
}  // menu()

void playCollisionSound() {
	play_sound_index(0);
}

void playBGMSound() {
	play_sound_index(1);
}

void playGameOverSound() {
	play_sound_index(2);
}

void playEndRoundSound() {
	play_sound_index(3);
}
